name: Build and Release RetroSpin.db

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up directory structure
        run: |
          mkdir -p dist/media/fat/retrospin
          mkdir -p dist/media/fat/Scripts
          mkdir -p db

      - name: Copy RetroSpin files
        run: |
          cp retrospin_launcher.py dist/media/fat/retrospin/
          cp save_disc.sh dist/media/fat/retrospin/
          cp retrospin.sh dist/media/fat/Scripts/
          cp games.db dist/media/fat/retrospin/

      - name: Set executable permissions
        run: |
          chmod +x dist/media/fat/retrospin/retrospin_launcher.py
          chmod +x dist/media/fat/retrospin/save_disc.sh
          chmod +x dist/media/fat/Scripts/retrospin.sh

      - name: Create retrospin_db.json
        run: |
          cat << EOF > retrospin_db.json
          {
            "db_id": "mister_retrospin",
            "timestamp": $(date +%s),
            "files": {
              "media/fat/retrospin/retrospin_launcher.py": {
                "hash": "$(md5sum dist/media/fat/retrospin/retrospin_launcher.py | cut -d' ' -f1)",
                "size": $(wc -c < dist/media/fat/retrospin/retrospin_launcher.py),
                "url": "https://raw.githubusercontent.com/towerwatchman/MiSTer_RetroSpin/main/retrospin_launcher.py",
                "tags": ["retrospin", "utility"],
                "overwrite": true,
                "reboot": false
              },
              "media/fat/retrospin/save_disc.sh": {
                "hash": "$(md5sum dist/media/fat/retrospin/save_disc.sh | cut -d' ' -f1)",
                "size": $(wc -c < dist/media/fat/retrospin/save_disc.sh),
                "url": "https://raw.githubusercontent.com/towerwatchman/MiSTer_RetroSpin/main/save_disc.sh",
                "tags": ["retrospin", "utility"],
                "overwrite": true,
                "reboot": false
              },
              "media/fat/Scripts/retrospin.sh": {
                "hash": "$(md5sum dist/media/fat/Scripts/retrospin.sh | cut -d' ' -f1)",
                "size": $(wc -c < dist/media/fat/Scripts/retrospin.sh),
                "url": "https://raw.githubusercontent.com/towerwatchman/MiSTer_RetroSpin/main/retrospin.sh",
                "tags": ["retrospin", "utility"],
                "overwrite": true,
                "reboot": false
              },
              "media/fat/retrospin/games.db": {
                "hash": "$(md5sum dist/media/fat/retrospin/games.db | cut -d' ' -f1)",
                "size": $(wc -c < dist/media/fat/retrospin/games.db),
                "url": "https://raw.githubusercontent.com/towerwatchman/MiSTer_RetroSpin/main/games.db",
                "tags": ["retrospin", "utility"],
                "overwrite": true,
                "reboot": false
              }
            },
            "folders": {
              "media/fat/retrospin/": {
                "tags": ["retrospin"]
              },
              "media/fat/Scripts/": {
                "tags": ["retrospin"]
              }
            },
            "default_options": {
              "filter": "retrospin"
            }
          }
          EOF

      - name: Zip retrospin_db.json
        run: |
          zip -j db/retrospin_db.json.zip retrospin_db.json

      - name: Update .gitignore to allow db/retrospin_db.json.zip
        run: |
          if [ -f .gitignore ]; then
            grep -q '^!db/retrospin_db.json.zip$' .gitignore || echo '!db/retrospin_db.json.zip' >> .gitignore
          else
            echo '!db/retrospin_db.json.zip' > .gitignore
          fi

      - name: Create RetroSpin.db
        run: |
          cd dist
          tar -cvf RetroSpin.db media
          mv RetroSpin.db ../
          cd ..

      - name: Upload RetroSpin.db artifact
        uses: actions/upload-artifact@v4
        with:
          name: RetroSpin.db
          path: RetroSpin.db

      - name: Debug repository permissions
        run: |
          echo "Git remote URL:"
          git remote -v
          echo "Current branch:"
          git branch --show-current
          echo "Checking user permissions:"
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/towerwatchman/MiSTer_RetroSpin/collaborators/github-actions%5Bbot%5D/permission || echo "Failed to fetch permission"
          echo "Checking branch protections:"
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/towerwatchman/MiSTer_RetroSpin/branches/main/protection || echo "No protections or failed to fetch"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push Changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -f db/retrospin_db.json.zip
          git add .gitignore
          git commit -m "Update retrospin_db.json.zip and .gitignore" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: RetroSpin.db
          name: RetroSpin ${{ github.ref_name }}
          body: |
            RetroSpin distribution for MiSTer FPGA.
            Includes retrospin_launcher.py, save_disc.sh, retrospin.sh, and games.db.
            Requires cdrdao and toc2cue installed separately in /media/fat/_Utility/.
            Install via MiSTer Downloader: https://raw.githubusercontent.com/towerwatchman/MiSTer_RetroSpin/main/db/retrospin_db.json.zip
            or manually extract RetroSpin.db to /media/fat/.
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}